name: Deployment Status Workflow

on:
  push:
    branches:
      - main

jobs:
  pre-deployment:
    name: pre-deployment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint || true

      - name: Test
        run: npm test || true

      - name: Get commit and version info
        id: info
        run: |
          echo "PREV_SHA=$(git rev-parse HEAD^)" >> $GITHUB_OUTPUT
          echo "CURR_SHA=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "PKG_VERSION=$(jq -r .version package.json)" >> $GITHUB_OUTPUT

      - name: Create deployment tracking issue
        id: create_issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Deployment Tracking - ${process.env.GITHUB_SHA}`;
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              labels: ['deployment', 'in-progress'],
              body: `Deployment tracking for commit: ${process.env.GITHUB_SHA}`
            });
            core.setOutput('issue_number', issue.number);

      - name: Post pre-deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create_issue.outputs.issue_number }},
              body: 'Pre-deployment checks completed'
            });

      - name: Save deployment info
        run: |
          echo "${{ steps.create_issue.outputs.issue_number }}" > .deployment-issue
          echo "${{ steps.info.outputs.PREV_SHA }}" > .prev-sha
          echo "${{ steps.info.outputs.CURR_SHA }}" > .curr-sha
          echo "${{ steps.info.outputs.PKG_VERSION }}" > .pkg-version
        shell: bash
      - name: Upload deployment info
        uses: actions/upload-artifact@v4
        with:
          name: deployment-info
          path: |
            .deployment-issue
            .prev-sha
            .curr-sha
            .pkg-version
          retention-days: 30

  rollback-preparation:
    name: rollback-preparation
    needs: pre-deployment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Download deployment info
        uses: actions/download-artifact@v4
        with:
          name: deployment-info

      - name: Set variables
        id: vars
        run: |
          ISSUE=$(cat .deployment-issue)
          PREV_SHA=$(cat .prev-sha)
          CURR_SHA=$(cat .curr-sha)
          PKG_VERSION=$(cat .pkg-version)
          echo "issue_number=$ISSUE" >> $GITHUB_OUTPUT
          echo "prev_sha=$PREV_SHA" >> $GITHUB_OUTPUT
          echo "curr_sha=$CURR_SHA" >> $GITHUB_OUTPUT
          echo "pkg_version=$PKG_VERSION" >> $GITHUB_OUTPUT

      - name: Backup configuration files
        run: |
          mkdir -p rollback/config-backup
          cp package.json rollback/config-backup/
          cp package-lock.json rollback/config-backup/ || true
          cp .env.example rollback/config-backup/ || true

      - name: Create rollback script
        run: |
          cat <<'EOF' > rollback/rollback.sh
          #!/bin/bash
          set -euo pipefail
          echo "Rolling back to commit $1..."
          git fetch origin
          git checkout $1
          npm ci
          echo "Rollback complete."
          EOF
          chmod +x rollback/rollback.sh

      - name: Create dependency verification script
        run: |
          cat <<'EOF' > rollback/verify-deps.sh
          #!/bin/bash
          set -euo pipefail
          npm ci
          npm ls --depth=0
          EOF
          chmod +x rollback/verify-deps.sh

      - name: Create rollback documentation
        run: |
          cat <<'EOF' > rollback/README.md
          # Rollback Instructions
          
          ## Steps
          1. Extract the rollback package.
          2. Run `bash rollback.sh <previous-commit-sha>`
          3. Verify dependencies with `bash verify-deps.sh`
          4. Restore configuration files from `config-backup/` if needed.
          5. Confirm application health.
          
          ## Quick Command
          ```bash
          bash rollback.sh <previous-commit-sha>
          ```
          EOF

      - name: Compress rollback package
        run: |
          ROLLBACK_NAME="rollback-package-${{ steps.vars.outputs.curr_sha }}.tar.gz"
          tar -czf "$ROLLBACK_NAME" -C rollback .
          sha256sum "$ROLLBACK_NAME" | tee rollback-sha256.txt
          echo "ROLLBACK_NAME=$ROLLBACK_NAME" >> $GITHUB_ENV

      - name: Upload rollback artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ROLLBACK_NAME }}
          path: ${{ env.ROLLBACK_NAME }}
          retention-days: 30

      - name: Get artifact checksum
        id: checksum
        run: |
          CHECKSUM=$(cat rollback-sha256.txt | awk '{print $1}')
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT

      - name: Post rollback plan comment
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = Number('${{ steps.vars.outputs.issue_number }}');
            const prev_sha = '${{ steps.vars.outputs.prev_sha }}';
            const curr_sha = '${{ steps.vars.outputs.curr_sha }}';
            const pkg_version = '${{ steps.vars.outputs.pkg_version }}';
            const artifact = 'rollback-package-' + curr_sha;
            const checksum = '${{ steps.checksum.outputs.checksum }}';
            const body = [
              '### ðŸ”„ Rollback Plan Ready',
              `Previous Commit: ${prev_sha}`,
              `Current Commit: ${curr_sha}`,
              `Package Version: ${pkg_version}`,
              `Artifact: ${artifact}`,
              'âœ… Rollback script created',
              'âœ… Configuration backup complete',
              'âœ… Dependency verification script ready',
              'âœ… Rollback documentation written',
              'âœ… Artifact compressed and checksum generated',
              '```bash',
              `bash rollback.sh ${prev_sha}`,
              '```',
              'Rollback script created: true',
              'Configuration backup: true',
              `SHA256: ${checksum}`
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body
            });

  post-deployment:
    name: post-deployment
    needs: rollback-preparation
    runs-on: ubuntu-latest
    steps:
      - name: Download deployment info
        uses: actions/download-artifact@v4
        with:
          name: deployment-info

      - name: Set variables
        id: vars
        run: |
          ISSUE=$(cat .deployment-issue)
          CURR_SHA=$(cat .curr-sha)
          echo "issue_number=$ISSUE" >> $GITHUB_OUTPUT
          echo "curr_sha=$CURR_SHA" >> $GITHUB_OUTPUT

      - name: Remove in-progress label, add completed label
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = Number('${{ steps.vars.outputs.issue_number }}');
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              name: 'in-progress'
            });
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              labels: ['completed']
            });

      - name: Post deployment completed comment
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = Number('${{ steps.vars.outputs.issue_number }}');
            const curr_sha = '${{ steps.vars.outputs.curr_sha }}';
            const artifact = 'rollback-package-' + curr_sha;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body: `Deployment Completed Successfully\n\nRollback artifact: ${artifact}`
            });

      - name: Close deployment tracking issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = Number('${{ steps.vars.outputs.issue_number }}');
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              state: 'closed'
            });
